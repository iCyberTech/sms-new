<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduManage Pro | School Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, set, get, child, push, update, remove } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDywun1wpfxaXbaDoxyZD1SS0tsJ6ZIvX0",
            authDomain: "single-sms.firebaseapp.com",
            projectId: "single-sms",
            storageBucket: "single-sms.appspot.com",
            messagingSenderId: "875632398588",
            appId: "1:875632398588:web:fd914d772caf8dfc3f8779",
            measurementId: "G-Z6QF53JGVP",
            databaseURL: "https://single-sms-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Make Firebase available globally
        window.firebase = {
            database,
            ref,
            set,
            get,
            child,
            push,
            update,
            remove,
            auth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        };
    </script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --dark-color: #2d3436;
            --light-color: #f5f6fa;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #d63031;
            --shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            --shadow-inset: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            --border-radius: 15px;
            --transition: all 0.3s ease;
        }
        /* Tabs */
.tabs {
    display: flex;
    border-bottom: 1px solid #ecf0f1;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 10px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 500;
    color: #7f8c8d;
    transition: var(--transition);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-btn:hover:not(.active) {
    color: var(--dark-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Admission details */
.admission-details-container {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 15px;
    margin-bottom: 20px;
}

.admission-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.admission-detail-group {
    margin-bottom: 15px;
}

.admission-detail-label {
    font-weight: 500;
    color: #7f8c8d;
    font-size: 14px;
    margin-bottom: 5px;
}

.admission-detail-value {
    font-size: 16px;
    word-break: break-word;
}

.admission-status {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.admission-status.pending {
    background-color: rgba(253, 203, 110, 0.2);
    color: #e17055;
}

.admission-status.under-review {
    background-color: rgba(108, 92, 231, 0.2);
    color: var(--primary-color);
}

.admission-status.accepted {
    background-color: rgba(0, 184, 148, 0.2);
    color: var(--success-color);
}

.admission-status.rejected {
    background-color: rgba(214, 48, 49, 0.2);
    color: var(--danger-color);
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            box-shadow: var(--shadow);
            z-index: 10;
            transition: var(--transition);
            transform: translateX(-100%);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-left: 10px;
        }

        .logo i {
            font-size: 28px;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .logo h2 {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .menu {
            margin-top: 40px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .menu-item:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .menu-item.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-inset);
        }

        .menu-item i {
            font-size: 20px;
            margin-right: 15px;
        }

        .menu-item span {
            font-size: 16px;
            font-weight: 500;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 0;
            transition: var(--transition);
            overflow-y: auto;
            max-height: 100vh;
        }

        .main-content.active {
            margin-left: 280px;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .menu-toggle {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
            color: var(--dark-color);
            background: var(--light-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-color);
            color: white;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            box-shadow: var(--shadow);
        }

        .user-info .user-name {
            font-weight: 500;
            margin-right: 15px;
        }

        .logout-btn {
            background: var(--light-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            color: var(--dark-color);
        }

        .logout-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        /* Dashboard Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 12px 12px 24px #d1d9e6, -12px -12px 24px #ffffff;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: var(--shadow);
        }

        .card-icon.students {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .card-icon.teachers {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .card-icon.classes {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .card-icon.finance {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .card-title {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .card-value {
            font-size: 28px;
            font-weight: 600;
            margin: 5px 0;
        }

        .card-change {
            font-size: 12px;
            display: flex;
            align-items: center;
        }

        .card-change.positive {
            color: var(--success-color);
        }

        .card-change.negative {
            color: var(--danger-color);
        }

        /* Content Section */
        .content-section {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
        }

        .section-actions button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .section-actions button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .section-actions button i {
            margin-right: 5px;
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        th.sort-asc::after {
            content: " ↑";
        }

        th.sort-desc::after {
            content: " ↓";
        }

        tr:hover {
            background-color: rgba(108, 92, 231, 0.05);
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.active {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }

        .status.inactive {
            background-color: rgba(214, 48, 49, 0.1);
            color: var(--danger-color);
        }

        .status.paid {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }

        .status.partial {
            background-color: rgba(253, 203, 110, 0.2);
            color: #e17055;
        }

        .status.unpaid {
            background-color: rgba(214, 48, 49, 0.1);
            color: var(--danger-color);
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
            margin-right: 5px;
        }

        .edit-btn {
            background-color: rgba(253, 203, 110, 0.2);
            color: #e17055;
        }

        .edit-btn:hover {
            background-color: rgba(253, 203, 110, 0.4);
        }

        .delete-btn {
            background-color: rgba(214, 48, 49, 0.2);
            color: var(--danger-color);
        }

        .delete-btn:hover {
            background-color: rgba(214, 48, 49, 0.4);
        }

        /* Form Styles */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            overflow-y: auto;
            max-height: 80vh;
        }

        .form-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--primary-color);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-col {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: var(--border-radius);
            background: var(--light-color);
            box-shadow: var(--shadow-inset);
            font-size: 14px;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff, 0 0 0 2px var(--secondary-color);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            box-shadow: var(--shadow);
        }

        .btn-secondary:hover {
            background: #dfe6e9;
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 700px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: var(--transition);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .login-logo {
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 50px;
            color: var(--primary-color);
        }

        .login-logo h1 {
            font-size: 28px;
            font-weight: 600;
            margin-top: 15px;
            color: var(--primary-color);
        }

        .login-message {
            margin-bottom: 30px;
            color: #7f8c8d;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .main-content.active {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .cards {
                grid-template-columns: 1fr;
            }
            
            .admission-details {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        /* Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Report table styles */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .report-table th, 
        .report-table td {
            padding: 10px;
            border: 1px solid #ecf0f1;
            text-align: left;
        }

        .report-table th {
            background-color: #f5f6fa;
            font-weight: 600;
        }

        .report-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .report-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Stats card styles */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin: 10px 0;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Editable table */
        .editable-table input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .editable-table select {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .save-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-btn:hover {
            background-color: #00a884;
        }

        /* Fees section */
        .fees-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .fees-filter select, 
        .fees-filter input {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }

        .fees-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        /* Fee types styles */
        .fee-types-container {
            margin-bottom: 20px;
        }

        .fee-type-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-type-info {
            flex: 1;
        }

        .fee-type-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .fee-type-amount {
            color: var(--primary-color);
            font-weight: 500;
        }

        .fee-type-actions {
            display: flex;
            gap: 10px;
        }

        /* Fee breakdown styles */
        .fee-breakdown {
            margin-top: 15px;
            padding: 10px;
            background: #f5f6fa;
            border-radius: var(--border-radius);
        }

        .fee-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .fee-breakdown-item:last-child {
            border-bottom: none;
        }

        .fee-breakdown-label {
            font-weight: 500;
        }

        .fee-breakdown-value {
            font-weight: 600;
        }

        .fee-breakdown-total {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Payment history styles */
        .payment-history {
            margin-top: 20px;
        }

        .payment-history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .payment-date {
            color: #7f8c8d;
            font-size: 14px;
        }

        .payment-amount {
            font-weight: 600;
            color: var(--success-color);
        }

        /* Add fee type button */
        .add-fee-type-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }

        .add-fee-type-btn:hover {
            background: var(--secondary-color);
        }
        
        /* Editable fee cells */
        .editable-fee-cell {
            padding: 0;
        }
        
        .editable-fee-cell input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .editable-fee-cell select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Fee status dropdown */
        .fee-status-dropdown {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        
        .fee-status-dropdown.paid {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--success-color);
        }
        
        .fee-status-dropdown.partial {
            background-color: rgba(253, 203, 110, 0.2);
            color: #e17055;
        }
        
        .fee-status-dropdown.unpaid {
            background-color: rgba(214, 48, 49, 0.1);
            color: var(--danger-color);
        }
        
        /* Save row button */
        .save-row-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .save-row-btn:hover {
            background-color: #00a884;
        }
        
        /* Logins section */
        .logins-search {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .logins-search input {
            flex: 1;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }
        
        .logins-search button {
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
        }
        
        .login-record {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }
        
        .login-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .login-user {
            font-weight: 600;
        }
        
        .login-time {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .login-details {
            display: flex;
            gap: 20px;
        }
        
        .login-detail {
            font-size: 14px;
        }
        
        .login-detail-label {
            color: #7f8c8d;
            margin-right: 5px;
        }
        
        .login-status.success {
            color: var(--success-color);
        }
        
        .login-status.failed {
            color: var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-graduation-cap floating"></i>
                <h1>EduManage Pro</h1>
            </div>
            <p class="login-message">Please sign in to access the school management system</p>
            <form id="login-form">
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email Address" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
                <div id="login-error" class="text-center" style="color: var(--danger-color); margin-top: 15px;"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h2>EduManage Pro</h2>
            </div>
            <div class="menu">
                <div class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-section="students">
                    <i class="fas fa-users"></i>
                    <span>Students</span>
                </div>
                <div class="menu-item" data-section="teachers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Teachers</span>
                </div>
                <div class="menu-item" data-section="classes">
                    <i class="fas fa-school"></i>
                    <span>Classes</span>
                </div>
                <div class="menu-item" data-section="enrollment">
                    <i class="fas fa-user-plus"></i>
                    <span>Enrollment</span>
                </div>
                <div class="menu-item" data-section="fees">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Fees</span>
                </div>
                <div class="menu-item" data-section="logins">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Logins</span>
                </div>
                <div class="menu-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
                <div class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <div class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </div>
                    <div class="page-title">
                        <h1>Dashboard</h1>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-name">Admin User</span>
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=6c5ce7&color=fff" alt="User">
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="cards">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total Students</div>
                                <div class="card-value" id="total-students">0</div>
                                <div class="card-change positive">
                                    <i class="fas fa-arrow-up"></i> 12% from last month
                                </div>
                            </div>
                            <div class="card-icon students">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total Teachers</div>
                                <div class="card-value" id="total-teachers">0</div>
                                <div class="card-change positive">
                                    <i class="fas fa-arrow-up"></i> 5% from last month
                                </div>
                            </div>
                            <div class="card-icon teachers">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total Classes</div>
                                <div class="card-value" id="total-classes">0</div>
                                <div class="card-change positive">
                                    <i class="fas fa-arrow-up"></i> 8% from last month
                                </div>
                            </div>
                            <div class="card-icon classes">
                                <i class="fas fa-school"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">School Finance</div>
                                <div class="card-value">$<span id="total-finance">0</span></div>
                                <div class="card-change negative">
                                    <i class="fas fa-arrow-down"></i> <span id="unpaid-fees-change">3%</span> from last month
                                </div>
                            </div>
                            <div class="card-icon finance">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Recent Enrollments</div>
                        <div class="section-actions">
                            <button id="view-all-enrollments">
                                <i class="fas fa-eye"></i> View All
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-enrollments">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Section -->
            <div id="students-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Student Management</div>
                    <div class="section-actions">
                        <button id="add-student-btn">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Gender</th>
                                <th>Date of Birth</th>
                                <th>Parent</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Teachers Section -->
            <div id="teachers-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Teacher Management</div>
                    <div class="section-actions">
                        <button id="add-teacher-btn">
                            <i class="fas fa-plus"></i> Add Teacher
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subjects</th>
                                <th>Class Assigned</th>
                                <th>Join Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="teachers-table-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Classes Section -->
            <div id="classes-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Class Management</div>
                    <div class="section-actions">
                        <button id="add-class-btn">
                            <i class="fas fa-plus"></i> Add Class
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Class ID</th>
                                <th>Class Name</th>
                                <th>Teacher</th>
                                <th>Students</th>
                                <th>Schedule</th>
                                <th>Room</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="classes-table-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admissions Section -->
            <div id="enrollment-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Student Admissions</div>
                    <div class="section-actions">
                        <button id="view-admissions-stats">
                            <i class="fas fa-chart-pie"></i> View Stats
                        </button>
                    </div>
                </div>
                
                <div class="tabs" style="margin-bottom: 20px;">
                    <button class="tab-btn active" data-tab="pending-tab">Pending</button>
                    <button class="tab-btn" data-tab="review-tab">Under Review</button>
                    <button class="tab-btn" data-tab="processed-tab">Processed</button>
                </div>
                
                <div id="pending-tab" class="tab-content active">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>App ID</th>
                                    <th>Student Name</th>
                                    <th>Grade</th>
                                    <th>Parent</th>
                                    <th>Apply Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-admissions">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="review-tab" class="tab-content">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>App ID</th>
                                    <th>Student Name</th>
                                    <th>Grade</th>
                                    <th>Parent</th>
                                    <th>Apply Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="review-admissions">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="processed-tab" class="tab-content">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>App ID</th>
                                    <th>Student Name</th>
                                    <th>Grade</th>
                                    <th>Status</th>
                                    <th>Feedback</th>
                                    <th>Processed Date</th>
                                </tr>
                            </thead>
                            <tbody id="processed-admissions">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Fees Section -->
            <div id="fees-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Student Fees Management</div>
                    <div class="section-actions">
                        <button id="add-fee-type-btn" class="add-fee-type-btn">
                            <i class="fas fa-plus"></i> Add Fee Type
                        </button>
                    </div>
                </div>
                
                <div class="fee-types-container" id="fee-types-container">
                    <!-- Fee types will be loaded here -->
                </div>
                
                <div class="fees-filter">
                    <select id="fees-class-filter">
                        <option value="">All Classes</option>
                        <!-- Filled by JavaScript -->
                    </select>
                    <select id="fees-status-filter">
                        <option value="">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partial</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                    <input type="text" id="fees-search" placeholder="Search by student name...">
                </div>
                
                <div class="fees-actions">
                    <button id="refresh-fees" class="btn btn-secondary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="save-all-fees" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="editable-table">
                        <thead>
                            <tr>
                                <th data-sort="id">Student ID</th>
                                <th data-sort="name">Name</th>
                                <th data-sort="class">Class</th>
                                <th data-sort="amount">Total Due ($)</th>
                                <th data-sort="paid">Amount Paid ($)</th>
                                <th data-sort="balance">Balance ($)</th>
                                <th data-sort="status">Status</th>
                                <th data-sort="duedate">Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fees-table-body">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Logins Section -->
            <div id="logins-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">Login History</div>
                    <div class="section-actions">
                        <button id="refresh-logins">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="logins-search">
                    <input type="text" id="logins-search" placeholder="Search by name, email or role...">
                    <button id="search-logins">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div id="logins-container">
                    <!-- Login records will be loaded here -->
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">School Reports</div>
                </div>
                <div class="cards">
                    <div class="card" id="student-report-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Student Report</div>
                                <div class="card-value">Generate</div>
                            </div>
                            <div class="card-icon students">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card" id="teacher-report-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Teacher Report</div>
                                <div class="card-value">Generate</div>
                            </div>
                            <div class="card-icon teachers">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card" id="finance-report-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Finance Report</div>
                                <div class="card-value">Generate</div>
                            </div>
                            <div class="card-icon finance">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card" id="fees-report-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Fees Report</div>
                                <div class="card-value">Generate</div>
                            </div>
                            <div class="card-icon finance">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-section hidden">
                <div class="section-header">
                    <div class="section-title">System Settings</div>
                </div>
                <div class="form-container">
                    <div class="form-title">School Information</div>
                    <form id="school-settings-form">
                        <div class="form-group">
                            <label for="school-name">School Name</label>
                            <input type="text" id="school-name" placeholder="Enter school name">
                        </div>
                        <div class="form-group">
                            <label for="school-address">Address</label>
                            <input type="text" id="school-address" placeholder="Enter school address">
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="school-phone">Phone Number</label>
                                    <input type="tel" id="school-phone" placeholder="Enter phone number">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="school-email">Email Address</label>
                                    <input type="email" id="school-email" placeholder="Enter email address">
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal" id="add-student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Student</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-student-form">
                <div class="form-group">
                    <label for="student-first-name">First Name</label>
                    <input type="text" id="student-first-name" required>
                </div>
                <div class="form-group">
                    <label for="student-last-name">Last Name</label>
                    <input type="text" id="student-last-name" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-gender">Gender</label>
                            <select id="student-gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-dob">Date of Birth</label>
                            <input type="date" id="student-dob" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="student-address">Address</label>
                    <input type="text" id="student-address" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-parent-name">Parent Name</label>
                            <input type="text" id="student-parent-name" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-parent-phone">Parent Phone</label>
                            <input type="tel" id="student-parent-phone" required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-parent-email">Parent Email</label>
                            <input type="email" id="student-parent-email" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="student-class">Class</label>
                            <select id="student-class" required>
                                <option value="">Select Class</option>
                                <!-- Filled by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div class="modal" id="add-teacher-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Teacher</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-teacher-form">
                <div class="form-group">
                    <label for="teacher-first-name">First Name</label>
                    <input type="text" id="teacher-first-name" required>
                </div>
                <div class="form-group">
                    <label for="teacher-last-name">Last Name</label>
                    <input type="text" id="teacher-last-name" required>
                </div>
                <div class="form-group">
                    <label for="teacher-email">Email Address</label>
                    <input type="email" id="teacher-email" required>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="teacher-gender">Gender</label>
                            <select id="teacher-gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="teacher-phone">Phone Number</label>
                            <input type="tel" id="teacher-phone" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="teacher-subjects">Subjects (comma separated)</label>
                    <input type="text" id="teacher-subjects" placeholder="e.g. Math, Science, English" required>
                </div>
                <div class="form-group">
                    <label for="teacher-class">Assigned Class (optional)</label>
                    <select id="teacher-class">
                        <option value="">Select Class</option>
                        <!-- Filled by JavaScript -->
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Teacher</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal" id="add-class-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Class</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-class-form">
                <div class="form-group">
                    <label for="class-name">Class Name</label>
                    <input type="text" id="class-name" placeholder="e.g. Grade 10A" required>
                </div>
                <div class="form-group">
                    <label for="class-teacher">Class Teacher</label>
                    <select id="class-teacher">
                        <option value="">Select Teacher</option>
                        <!-- Filled by JavaScript -->
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="class-room">Room Number</label>
                            <input type="text" id="class-room" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="class-capacity">Capacity</label>
                            <input type="number" id="class-capacity" min="1" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="class-schedule">Schedule</label>
                    <input type="text" id="class-schedule" placeholder="e.g. Mon-Fri, 8:00-14:00" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Class</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enrollment Modal -->
    <div class="modal" id="enrollment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Student Enrollment</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="enrollment-form">
                <div class="form-group">
                    <label for="enrollment-student">Student</label>
                    <select id="enrollment-student" required>
                        <option value="">Select Student</option>
                        <!-- Filled by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="enrollment-class">Class</label>
                    <select id="enrollment-class" required>
                        <option value="">Select Class</option>
                        <!-- Filled by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="enrollment-date">Enrollment Date</label>
                    <input type="date" id="enrollment-date" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Complete Enrollment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admission Details Modal -->
    <div class="modal" id="admission-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admission Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="admission-details-container">
                <div id="admission-details-content">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            <div class="form-actions" id="admission-action-buttons">
                <!-- Buttons will be added based on status -->
            </div>
        </div>
    </div>

    <!-- Admission Feedback Modal -->
    <div class="modal" id="admission-feedback-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Update Admission Status</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="admission-feedback-form">
                <input type="hidden" id="current-application-id">
                <div class="form-group">
                    <label for="admission-status">Status</label>
                    <select id="admission-status" required>
                        <option value="under-review">Under Review</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="admission-feedback">Feedback</label>
                    <textarea id="admission-feedback" rows="4" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="report-modal-title">Generate Report</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-container">
                <div id="report-content">
                    <!-- Report content will be generated here -->
                </div>
                <div class="form-actions mt-20">
                    <button type="button" class="btn btn-secondary close-modal">Close</button>
                    <button type="button" class="btn btn-primary" id="print-report-btn">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Fee Type Modal -->
    <div class="modal" id="add-fee-type-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Fee Type</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="add-fee-type-form">
                <div class="form-group">
                    <label for="fee-type-title">Fee Title</label>
                    <input type="text" id="fee-type-title" placeholder="e.g. Tuition Fee, Activity Fee" required>
                </div>
                <div class="form-group">
                    <label for="fee-type-amount">Amount ($)</label>
                    <input type="number" id="fee-type-amount" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="fee-type-role">Applicable Role</label>
                    <select id="fee-type-role" required>
                        <option value="">Select Role</option>
                        <option value="all">All Students</option>
                        <option value="grade1">Grade 1</option>
                        <option value="grade2">Grade 2</option>
                        <option value="grade3">Grade 3</option>
                        <option value="grade4">Grade 4</option>
                        <option value="grade5">Grade 5</option>
                        <option value="grade6">Grade 6</option>
                        <option value="grade7">Grade 7</option>
                        <option value="grade8">Grade 8</option>
                        <option value="grade9">Grade 9</option>
                        <option value="grade10">Grade 10</option>
                        <option value="grade11">Grade 11</option>
                        <option value="grade12">Grade 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fee-type-description">Description (Optional)</label>
                    <textarea id="fee-type-description" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Fee Type</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Fee Details Modal -->
    <div class="modal" id="fee-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Fee Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="fee-details-content">
                <!-- Content will be filled by JavaScript -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary close-modal">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const loginPage = document.getElementById('login-page');
            const app = document.getElementById('app');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');
            
            // Sidebar and navigation
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const menuItems = document.querySelectorAll('.menu-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            // Modal elements
            const modals = document.querySelectorAll('.modal');
            const closeModalButtons = document.querySelectorAll('.close-modal');
            const addStudentBtn = document.getElementById('add-student-btn');
            const addTeacherBtn = document.getElementById('add-teacher-btn');
            const addClassBtn = document.getElementById('add-class-btn');
            const viewAllEnrollmentsBtn = document.getElementById('view-all-enrollments');
            const addFeeTypeBtn = document.getElementById('add-fee-type-btn');
            
            // Report cards
            const studentReportCard = document.getElementById('student-report-card');
            const teacherReportCard = document.getElementById('teacher-report-card');
            const financeReportCard = document.getElementById('finance-report-card');
            const feesReportCard = document.getElementById('fees-report-card');
            
            // Fees elements
            const refreshFeesBtn = document.getElementById('refresh-fees');
            const saveAllFeesBtn = document.getElementById('save-all-fees');
            const feesClassFilter = document.getElementById('fees-class-filter');
            const feesStatusFilter = document.getElementById('fees-status-filter');
            const feesSearch = document.getElementById('fees-search');
            
            // Logins elements
            const refreshLoginsBtn = document.getElementById('refresh-logins');
            const searchLoginsBtn = document.getElementById('search-logins');
            const loginsSearch = document.getElementById('logins-search');
            
            // Firebase references
            const db = firebase.database;
            const auth = firebase.auth;
            
            // Initialize Firebase data references
            const studentsRef = firebase.ref(db, 'students');
            const teachersRef = firebase.ref(db, 'teachers');
            const classesRef = firebase.ref(db, 'classes');
            const enrollmentsRef = firebase.ref(db, 'enrollments');
            const admissionsRef = firebase.ref(db, 'admissions');
            const schoolRef = firebase.ref(db, 'school');
            const feesRef = firebase.ref(db, 'fees');
            const feeTypesRef = firebase.ref(db, 'feeTypes');
            const loginsRef = firebase.ref(db, 'logins');
            
            // Current user
            let currentUser = null;
            
            // Sorting variables
            let currentSortColumn = null;
            let sortDirection = 1; // 1 for ascending, -1 for descending
            
            // Toggle sidebar
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                mainContent.classList.toggle('active');
            });
            
            // Navigation
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all menu items
                    menuItems.forEach(i => i.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.add('hidden'));
                    
                    // Show the selected section
                    const sectionId = this.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    // Update page title
                    const pageTitle = document.querySelector('.page-title h1');
                    pageTitle.textContent = this.querySelector('span').textContent;
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('active');
                        mainContent.classList.remove('active');
                    }
                    
                    // Load admissions data if enrollment section is shown
                    if (sectionId === 'enrollment-section') {
                        loadAdmissionsData();
                    }
                    
                    // Load fees data if fees section is shown
                    if (sectionId === 'fees-section') {
                        loadFeeTypes();
                        loadFeesData();
                    }
                    
                    // Load logins data if logins section is shown
                    if (sectionId === 'logins-section') {
                        loadLoginsData();
                    }
                });
            });
            
            // Modal handling
            function openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }
            
            function closeAllModals() {
                modals.forEach(modal => modal.classList.remove('active'));
            }
            
            closeModalButtons.forEach(button => {
                button.addEventListener('click', closeAllModals);
            });
            
            modals.forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAllModals();
                    }
                });
            });
            
            // Open modals when buttons are clicked
            addStudentBtn.addEventListener('click', () => openModal('add-student-modal'));
            addTeacherBtn.addEventListener('click', () => openModal('add-teacher-modal'));
            addClassBtn.addEventListener('click', () => openModal('add-class-modal'));
            viewAllEnrollmentsBtn.addEventListener('click', () => {
                // Switch to enrollment section and show it
                document.querySelector('.menu-item[data-section="enrollment"]').click();
            });
            addFeeTypeBtn.addEventListener('click', () => openModal('add-fee-type-modal'));
            
            // Report cards click handlers
            studentReportCard.addEventListener('click', () => generateReport('students'));
            teacherReportCard.addEventListener('click', () => generateReport('teachers'));
            financeReportCard.addEventListener('click', () => generateReport('finance'));
            feesReportCard.addEventListener('click', () => generateReport('fees'));
            
            // Login form submission
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                firebase.signInWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        currentUser = userCredential.user;
                        loginPage.classList.add('hidden');
                        app.classList.remove('hidden');
                        
                        // Record login
                        recordLogin(userCredential.user.email, 'admin', true);
                        
                        loadData();
                    })
                    .catch((error) => {
                        loginError.textContent = error.message;
                        // Record failed login attempt
                        recordLogin(email, 'admin', false);
                    });
            });
            
            // Logout
            logoutBtn.addEventListener('click', function() {
                firebase.signOut(auth).then(() => {
                    currentUser = null;
                    app.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    loginError.textContent = '';
                    document.getElementById('login-form').reset();
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            });
            
            // Record login attempt
            function recordLogin(email, role, success) {
                const loginData = {
                    email: email,
                    role: role,
                    success: success,
                    timestamp: new Date().toISOString(),
                    ip: 'N/A' // In a real app, you'd capture the IP address
                };
                
                firebase.push(loginsRef, loginData)
                    .catch(error => {
                        console.error("Error recording login:", error);
                    });
            }
            
            // Load data from Firebase
            function loadData() {
                // Load students
                firebase.get(firebase.child(studentsRef, '/')).then((snapshot) => {
                    const students = snapshot.val() || {};
                    document.getElementById('total-students').textContent = Object.keys(students).length;
                    
                    // Populate students table
                    const studentsTableBody = document.getElementById('students-table-body');
                    studentsTableBody.innerHTML = '';
                    
                    for (const id in students) {
                        const student = students[id];
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${id.substring(0, 8)}</td>
                            <td>${student.firstName} ${student.lastName}</td>
                            <td>${student.class || 'Not assigned'}</td>
                            <td>${student.gender}</td>
                            <td>${student.dob}</td>
                            <td>${student.parentName}</td>
                            <td><span class="status active">Active</span></td>
                            <td>
                                <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        
                        studentsTableBody.appendChild(row);
                    }
                    
                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('#students-table-body .edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const studentId = this.getAttribute('data-id');
                            editStudent(studentId);
                        });
                    });
                    
                    document.querySelectorAll('#students-table-body .delete-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const studentId = this.getAttribute('data-id');
                            deleteStudent(studentId);
                        });
                    });
                    
                    // Populate student dropdowns
                    const studentSelects = document.querySelectorAll('#enrollment-student, #student-class');
                    studentSelects.forEach(select => {
                        if (select.id === 'enrollment-student') {
                            select.innerHTML = '<option value="">Select Student</option>';
                            for (const id in students) {
                                const student = students[id];
                                const option = document.createElement('option');
                                option.value = id;
                                option.textContent = `${student.firstName} ${student.lastName}`;
                                select.appendChild(option);
                            }
                        }
                    });
                }).catch(error => {
                    console.error("Error loading students:", error);
                });
                
                // Load teachers
                firebase.get(firebase.child(teachersRef, '/')).then((snapshot) => {
                    const teachers = snapshot.val() || {};
                    document.getElementById('total-teachers').textContent = Object.keys(teachers).length;
                    
                    // Populate teachers table
                    const teachersTableBody = document.getElementById('teachers-table-body');
                    teachersTableBody.innerHTML = '';
                    
                    for (const id in teachers) {
                        const teacher = teachers[id];
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${id.substring(0, 8)}</td>
                            <td>${teacher.firstName} ${teacher.lastName}</td>
                            <td>${teacher.email}</td>
                            <td>${teacher.subjects}</td>
                            <td>${teacher.assignedClass || 'Not assigned'}</td>
                            <td>${teacher.joinDate || 'N/A'}</td>
                            <td><span class="status active">Active</span></td>
                            <td>
                                <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        
                        teachersTableBody.appendChild(row);
                    }
                    
                    // Add event listeners to edit and delete buttons
                    document.querySelectorAll('#teachers-table-body .edit-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const teacherId = this.getAttribute('data-id');
                            editTeacher(teacherId);
                        });
                    });
                    
                    document.querySelectorAll('#teachers-table-body .delete-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const teacherId = this.getAttribute('data-id');
                            deleteTeacher(teacherId);
                        });
                    });
                    
                    // Populate teacher dropdowns
                    const teacherSelects = document.querySelectorAll('#class-teacher, #teacher-class');
                    teacherSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select Teacher</option>';
                        for (const id in teachers) {
                            const teacher = teachers[id];
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = `${teacher.firstName} ${teacher.lastName}`;
                            select.appendChild(option);
                        }
                    });
                }).catch(error => {
                    console.error("Error loading teachers:", error);
                });
                
                // Load classes
                firebase.get(firebase.child(classesRef, '/')).then((snapshot) => {
                    const classes = snapshot.val() || {};
                    document.getElementById('total-classes').textContent = Object.keys(classes).length;
                    
                    // Populate classes table
                    const classesTableBody = document.getElementById('classes-table-body');
                    classesTableBody.innerHTML = '';
                    
                    firebase.get(firebase.child(teachersRef, '/')).then((teacherSnapshot) => {
                        const teachers = teacherSnapshot.val() || {};
                        
                        for (const id in classes) {
                            const cls = classes[id];
                            const teacher = teachers[cls.teacherId] || {};
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${id.substring(0, 8)}</td>
                                <td>${cls.name}</td>
                                <td>${teacher.firstName ? `${teacher.firstName} ${teacher.lastName}` : 'Not assigned'}</td>
                                <td>${cls.studentCount || 0}/${cls.capacity}</td>
                                <td>${cls.schedule}</td>
                                <td>${cls.room}</td>
                                <td>
                                    <button class="action-btn edit-btn" data-id="${id}"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete-btn" data-id="${id}"><i class="fas fa-trash"></i></button>
                                </td>
                            `;
                            
                            classesTableBody.appendChild(row);
                        }
                        
                        // Add event listeners to edit and delete buttons
                        document.querySelectorAll('#classes-table-body .edit-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const classId = this.getAttribute('data-id');
                                editClass(classId);
                            });
                        });
                        
                        document.querySelectorAll('#classes-table-body .delete-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const classId = this.getAttribute('data-id');
                                deleteClass(classId);
                            });
                        });
                    }).catch(error => {
                        console.error("Error loading teachers for classes:", error);
                    });
                    
                    // Populate class dropdowns
                    const classSelects = document.querySelectorAll('#student-class, #enrollment-class, #teacher-class, #fees-class-filter');
                    classSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select Class</option>';
                        for (const id in classes) {
                            const cls = classes[id];
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = cls.name;
                            select.appendChild(option);
                        }
                    });
                }).catch(error => {
                    console.error("Error loading classes:", error);
                });
                
                // Load enrollments
                firebase.get(firebase.child(enrollmentsRef, '/')).then((snapshot) => {
                    const enrollments = snapshot.val() || {};
                    
                    // Populate recent enrollments
                    const recentEnrollments = document.getElementById('recent-enrollments');
                    recentEnrollments.innerHTML = '';
                    
                    // Get the 5 most recent enrollments
                    const enrollmentIds = Object.keys(enrollments);
                    const recentIds = enrollmentIds.slice(-5).reverse();
                    
                    firebase.get(firebase.child(studentsRef, '/')).then((studentSnapshot) => {
                        const students = studentSnapshot.val() || {};
                        
                        firebase.get(firebase.child(classesRef, '/')).then((classSnapshot) => {
                            const classes = classSnapshot.val() || {};
                            
                            for (const id of recentIds) {
                                const enrollment = enrollments[id];
                                const student = students[enrollment.studentId] || {};
                                const cls = classes[enrollment.classId] || {};
                                
                                const row = document.createElement('tr');
                                
                                row.innerHTML = `
                                    <td>${enrollment.studentId.substring(0, 8)}</td>
                                    <td>${student.firstName} ${student.lastName}</td>
                                    <td>${cls.name || 'N/A'}</td>
                                    <td>${enrollment.date}</td>
                                    <td><span class="status active">Active</span></td>
                                    <td>
                                        <button class="action-btn edit-btn"><i class="fas fa-edit"></i></button>
                                    </td>
                                `;
                                
                                recentEnrollments.appendChild(row);
                            }
                        }).catch(error => {
                            console.error("Error loading classes for enrollments:", error);
                        });
                    }).catch(error => {
                        console.error("Error loading students for enrollments:", error);
                    });
                }).catch(error => {
                    console.error("Error loading enrollments:", error);
                });
                
                // Load school info
                firebase.get(firebase.child(schoolRef, '/')).then((snapshot) => {
                    const schoolInfo = snapshot.val() || {};
                    
                    if (schoolInfo) {
                        document.getElementById('school-name').value = schoolInfo.name || '';
                        document.getElementById('school-address').value = schoolInfo.address || '';
                        document.getElementById('school-phone').value = schoolInfo.phone || '';
                        document.getElementById('school-email').value = schoolInfo.email || '';
                    }
                    
                    // Load unpaid fees total
                    loadUnpaidFeesTotal();
                }).catch(error => {
                    console.error("Error loading school info:", error);
                });
            }
            
            // Load unpaid fees total for dashboard
            function loadUnpaidFeesTotal() {
                Promise.all([
                    firebase.get(firebase.child(feesRef, '/')),
                    firebase.get(firebase.child(feeTypesRef, '/'))
                ]).then(([feesSnapshot, feeTypesSnapshot]) => {
                    const fees = feesSnapshot.val() || {};
                    const feeTypes = feeTypesSnapshot.val() || {};
                    
                    let totalUnpaid = 0;
                    let totalFinance = 0;
                    
                    // Calculate total unpaid fees
                    for (const studentId in fees) {
                        const studentFees = fees[studentId];
                        if (studentFees.feeItems) {
                            for (const feeId in studentFees.feeItems) {
                                const fee = studentFees.feeItems[feeId];
                                if (fee.status !== 'paid') {
                                    totalUnpaid += (fee.amountDue - fee.amountPaid);
                                }
                            }
                        } else if (studentFees.amountDue !== undefined) {
                            // Legacy fee structure (backward compatibility)
                            if (studentFees.status !== 'paid') {
                                totalUnpaid += (studentFees.amountDue - studentFees.amountPaid);
                            }
                        }
                    }
                    
                    // Calculate total finance (sum of all fee types)
                    for (const feeTypeId in feeTypes) {
                        totalFinance += feeTypes[feeTypeId].amount;
                    }
                    
                    // Update dashboard
                    document.getElementById('total-finance').textContent = totalFinance.toLocaleString();
                    document.getElementById('unpaid-fees-change').textContent = `$${totalUnpaid.toLocaleString()} unpaid`;
                    
                }).catch(error => {
                    console.error("Error loading fees data:", error);
                });
            }
            
            // Load fee types
            function loadFeeTypes() {
                firebase.get(firebase.child(feeTypesRef, '/')).then((snapshot) => {
                    const feeTypes = snapshot.val() || {};
                    const container = document.getElementById('fee-types-container');
                    container.innerHTML = '';
                    
                    for (const id in feeTypes) {
                        const feeType = feeTypes[id];
                        const card = document.createElement('div');
                        card.className = 'fee-type-card';
                        card.dataset.feeTypeId = id;
                        
                        card.innerHTML = `
                            <div class="fee-type-info">
                                <div class="fee-type-title">${feeType.title}</div>
                                <div class="fee-type-amount">$${feeType.amount.toFixed(2)}</div>
                                <div class="fee-type-role">${formatRole(feeType.role)}</div>
                            </div>
                            <div class="fee-type-actions">
                                <button class="action-btn edit-btn view-fee-type" data-id="${id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn delete-btn delete-fee-type" data-id="${id}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(card);
                    }
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-fee-type').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const feeTypeId = this.getAttribute('data-id');
                            viewFeeTypeDetails(feeTypeId);
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-fee-type').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const feeTypeId = this.getAttribute('data-id');
                            deleteFeeType(feeTypeId);
                        });
                    });
                    
                }).catch(error => {
                    console.error("Error loading fee types:", error);
                });
            }
            
            // Format role for display
            function formatRole(role) {
                if (role === 'all') return 'All Students';
                if (role.startsWith('grade')) {
                    return `Grade ${role.replace('grade', '')}`;
                }
                return role;
            }
            
            // View fee type details
            function viewFeeTypeDetails(feeTypeId) {
                firebase.get(firebase.ref(db, `feeTypes/${feeTypeId}`)).then((snapshot) => {
                    const feeType = snapshot.val();
                    
                    document.getElementById('fee-details-content').innerHTML = `
                        <div class="fee-details">
                            <div class="form-group">
                                <label>Fee Title</label>
                                <div class="detail-value">${feeType.title}</div>
                            </div>
                            <div class="form-group">
                                <label>Amount</label>
                                <div class="detail-value">$${feeType.amount.toFixed(2)}</div>
                            </div>
                            <div class="form-group">
                                <label>Applicable Role</label>
                                <div class="detail-value">${formatRole(feeType.role)}</div>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <div class="detail-value">${feeType.description || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                    
                    openModal('fee-details-modal');
                }).catch(error => {
                    console.error("Error loading fee type details:", error);
                });
            }
            
            // Delete fee type
            function deleteFeeType(feeTypeId) {
                if (confirm('Are you sure you want to delete this fee type? This will not delete existing fee records.')) {
                    firebase.remove(firebase.ref(db, `feeTypes/${feeTypeId}`))
                        .then(() => {
                            alert('Fee type deleted successfully!');
                            loadFeeTypes();
                        })
                        .catch((error) => {
                            alert('Error deleting fee type: ' + error.message);
                        });
                }
            }
            
            // Add fee type form submission
            document.getElementById('add-fee-type-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const feeType = {
                    title: document.getElementById('fee-type-title').value,
                    amount: parseFloat(document.getElementById('fee-type-amount').value),
                    role: document.getElementById('fee-type-role').value,
                    description: document.getElementById('fee-type-description').value,
                    createdAt: new Date().toISOString()
                };
                
                const newFeeTypeRef = firebase.push(feeTypesRef);
                firebase.set(newFeeTypeRef, feeType)
                    .then(() => {
                        alert('Fee type added successfully!');
                        closeAllModals();
                        this.reset();
                        loadFeeTypes();
                        loadUnpaidFeesTotal();
                    })
                    .catch((error) => {
                        alert('Error adding fee type: ' + error.message);
                    });
            });
            
            // Load fees data
            function loadFeesData() {
                Promise.all([
                    firebase.get(firebase.child(studentsRef, '/')),
                    firebase.get(firebase.child(classesRef, '/')),
                    firebase.get(firebase.child(feesRef, '/')),
                    firebase.get(firebase.child(feeTypesRef, '/'))
                ]).then(([studentsSnapshot, classesSnapshot, feesSnapshot, feeTypesSnapshot]) => {
                    const students = studentsSnapshot.val() || {};
                    const classes = classesSnapshot.val() || {};
                    const fees = feesSnapshot.val() || {};
                    const feeTypes = feeTypesSnapshot.val() || {};
                    
                    const feesTableBody = document.getElementById('fees-table-body');
                    feesTableBody.innerHTML = '';
                    
                    for (const studentId in students) {
                        const student = students[studentId];
                        const classInfo = classes[student.class] || {};
                        const studentFees = fees[studentId] || {};
                        
                        // Calculate total fees for this student
                        let totalDue = 0;
                        let totalPaid = 0;
                        let feeItems = [];
                        
                        if (studentFees.feeItems) {
                            // New fee structure with multiple fee items
                            feeItems = Object.values(studentFees.feeItems);
                            for (const feeItem of feeItems) {
                                totalDue += feeItem.amountDue;
                                totalPaid += feeItem.amountPaid;
                            }
                        } else if (studentFees.amountDue !== undefined) {
                            // Legacy fee structure (backward compatibility)
                            totalDue = studentFees.amountDue || 0;
                            totalPaid = studentFees.amountPaid || 0;
                            feeItems = [{
                                amountDue: totalDue,
                                amountPaid: totalPaid,
                                dueDate: studentFees.dueDate || '',
                                status: calculateStatus(totalDue, totalPaid)
                            }];
                        }
                        
                        const balance = totalDue - totalPaid;
                        const status = calculateStatus(totalDue, totalPaid);
                        
                        const row = document.createElement('tr');
                        row.dataset.studentId = studentId;
                        
                        row.innerHTML = `
                            <td>${studentId.substring(0, 8)}</td>
                            <td>${student.firstName} ${student.lastName}</td>
                            <td>${classInfo.name || 'Not assigned'}</td>
                            <td class="editable-fee-cell">
                                <input type="number" class="fee-total-due" value="${totalDue.toFixed(2)}" step="0.01" min="0">
                            </td>
                            <td class="editable-fee-cell">
                                <input type="number" class="fee-amount-paid" value="${totalPaid.toFixed(2)}" step="0.01" min="0" max="${totalDue}">
                            </td>
                            <td>${balance.toFixed(2)}</td>
                            <td class="editable-fee-cell">
                                <select class="fee-status-dropdown ${status}">
                                    <option value="paid" ${status === 'paid' ? 'selected' : ''}>Paid</option>
                                    <option value="partial" ${status === 'partial' ? 'selected' : ''}>Partial</option>
                                    <option value="unpaid" ${status === 'unpaid' ? 'selected' : ''}>Unpaid</option>
                                </select>
                            </td>
                            <td class="editable-fee-cell">
                                <input type="date" class="fee-due-date" value="${studentFees.dueDate || ''}">
                            </td>
                            <td>
                                <button class="save-row-btn" data-student-id="${studentId}">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button class="action-btn edit-btn view-fee-details" data-student-id="${studentId}">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </td>
                        `;
                        
                        feesTableBody.appendChild(row);
                    }
                    
                    // Add event listeners to save buttons
                    document.querySelectorAll('.save-row-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const studentId = this.getAttribute('data-student-id');
                            saveFeeRow(studentId);
                        });
                    });
                    
                    // Add event listeners to view details buttons
                    document.querySelectorAll('.view-fee-details').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const studentId = this.getAttribute('data-student-id');
                            viewStudentFeeDetails(studentId);
                        });
                    });
                    
                    // Add event listeners to amount paid inputs to update status
                    document.querySelectorAll('.fee-amount-paid').forEach(input => {
                        input.addEventListener('change', function() {
                            const row = this.closest('tr');
                            const totalDue = parseFloat(row.querySelector('.fee-total-due').value);
                            const amountPaid = parseFloat(this.value);
                            const statusDropdown = row.querySelector('.fee-status-dropdown');
                            
                            // Update status based on payment
                            if (amountPaid >= totalDue) {
                                statusDropdown.value = 'paid';
                            } else if (amountPaid > 0) {
                                statusDropdown.value = 'partial';
                            } else {
                                statusDropdown.value = 'unpaid';
                            }
                            
                            // Update dropdown styling
                            statusDropdown.className = `fee-status-dropdown ${statusDropdown.value}`;
                            
                            // Update balance
                            const balanceCell = row.querySelector('td:nth-child(6)');
                            balanceCell.textContent = (totalDue - amountPaid).toFixed(2);
                        });
                    });
                    
                    // Add sorting functionality
                    document.querySelectorAll('#fees-table-body th[data-sort]').forEach(th => {
                        th.addEventListener('click', function() {
                            const column = this.getAttribute('data-sort');
                            sortFeesTable(column);
                        });
                    });
                    
                    // Add filter functionality
                    feesClassFilter.addEventListener('change', applyFeesFilters);
                    feesStatusFilter.addEventListener('change', applyFeesFilters);
                    feesSearch.addEventListener('input', applyFeesFilters);
                    
                }).catch(error => {
                    console.error("Error loading fees data:", error);
                });
            }
            
            // Save a single fee row
            function saveFeeRow(studentId) {
                const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
                if (!row) return;
                
                const totalDue = parseFloat(row.querySelector('.fee-total-due').value);
                const amountPaid = parseFloat(row.querySelector('.fee-amount-paid').value);
                const status = row.querySelector('.fee-status-dropdown').value;
                const dueDate = row.querySelector('.fee-due-date').value;
                
                const feeData = {
                    amountDue: totalDue,
                    amountPaid: amountPaid,
                    status: status,
                    dueDate: dueDate,
                    updatedAt: new Date().toISOString()
                };
                
                firebase.update(firebase.ref(db, `fees/${studentId}`), feeData)
                    .then(() => {
                        alert('Fee record updated successfully!');
                        loadUnpaidFeesTotal();
                    })
                    .catch(error => {
                        alert('Error updating fee record: ' + error.message);
                    });
            }
            
            // Save all fee changes
            saveAllFeesBtn.addEventListener('click', function() {
                const updates = {};
                const rows = document.querySelectorAll('#fees-table-body tr');
                
                for (const row of rows) {
                    const studentId = row.dataset.studentId;
                    const totalDue = parseFloat(row.querySelector('.fee-total-due').value);
                    const amountPaid = parseFloat(row.querySelector('.fee-amount-paid').value);
                    const status = row.querySelector('.fee-status-dropdown').value;
                    const dueDate = row.querySelector('.fee-due-date').value;
                    
                    updates[studentId] = {
                        amountDue: totalDue,
                        amountPaid: amountPaid,
                        status: status,
                        dueDate: dueDate,
                        updatedAt: new Date().toISOString()
                    };
                }
                
                firebase.update(feesRef, updates)
                    .then(() => {
                        alert('All fee records updated successfully!');
                        loadUnpaidFeesTotal();
                    })
                    .catch(error => {
                        alert('Error updating fee records: ' + error.message);
                    });
            });
            
            // View student fee details
            function viewStudentFeeDetails(studentId) {
                Promise.all([
                    firebase.get(firebase.ref(db, `students/${studentId}`)),
                    firebase.get(firebase.ref(db, `fees/${studentId}`)),
                    firebase.get(firebase.ref(db, `classes/${studentId}`))
                ]).then(([studentSnapshot, feesSnapshot, classSnapshot]) => {
                    const student = studentSnapshot.val() || {};
                    const fees = feesSnapshot.val() || {};
                    const classInfo = classSnapshot.val() || {};
                    
                    let feeItems = [];
                    if (fees.feeItems) {
                        feeItems = Object.values(fees.feeItems);
                    } else if (fees.amountDue !== undefined) {
                        feeItems = [{
                            title: 'Tuition Fee',
                            amountDue: fees.amountDue || 0,
                            amountPaid: fees.amountPaid || 0,
                            dueDate: fees.dueDate || '',
                            status: calculateStatus(fees.amountDue, fees.amountPaid)
                        }];
                    }
                    
                    let feeBreakdown = '';
                    let totalDue = 0;
                    let totalPaid = 0;
                    
                    feeItems.forEach((fee, index) => {
                        totalDue += fee.amountDue;
                        totalPaid += fee.amountPaid;
                        
                        feeBreakdown += `
                            <div class="fee-breakdown-item">
                                <div class="fee-breakdown-label">${fee.title || 'Fee ' + (index + 1)}</div>
                                <div class="fee-breakdown-value">$${fee.amountDue.toFixed(2)}</div>
                            </div>
                        `;
                    });
                    
                    const balance = totalDue - totalPaid;
                    
                    document.getElementById('fee-details-content').innerHTML = `
                        <div class="student-info">
                            <h4>${student.firstName} ${student.lastName}</h4>
                            <p>Class: ${classInfo.name || 'Not assigned'}</p>
                        </div>
                        
                        <div class="fee-summary">
                            <div class="fee-breakdown">
                                <h5>Fee Breakdown</h5>
                                ${feeBreakdown}
                                <div class="fee-breakdown-item">
                                    <div class="fee-breakdown-label">Total Due</div>
                                    <div class="fee-breakdown-value">$${totalDue.toFixed(2)}</div>
                                </div>
                                <div class="fee-breakdown-item">
                                    <div class="fee-breakdown-label">Total Paid</div>
                                    <div class="fee-breakdown-value">$${totalPaid.toFixed(2)}</div>
                                </div>
                                <div class="fee-breakdown-item">
                                    <div class="fee-breakdown-label fee-breakdown-total">Balance</div>
                                    <div class="fee-breakdown-value fee-breakdown-total">$${balance.toFixed(2)}</div>
                                </div>
                            </div>
                            
                            <div class="payment-history">
                                <h5>Payment History</h5>
                                ${fees.payments ? Object.values(fees.payments).map(payment => `
                                    <div class="payment-history-item">
                                        <div>
                                            <div class="payment-date">${new Date(payment.date).toLocaleDateString()}</div>
                                            <div>${payment.description || 'Payment'}</div>
                                        </div>
                                        <div class="payment-amount">$${payment.amount.toFixed(2)}</div>
                                    </div>
                                `).join('') : '<p>No payment history found</p>'}
                            </div>
                        </div>
                    `;
                    
                    openModal('fee-details-modal');
                }).catch(error => {
                    console.error("Error loading student fee details:", error);
                });
            }
            
            // Calculate fee status
            function calculateStatus(amountDue, amountPaid) {
                if (amountPaid >= amountDue) return 'paid';
                if (amountPaid > 0) return 'partial';
                return 'unpaid';
            }
            
            // Sort fees table
            function sortFeesTable(column) {
                const table = document.querySelector('#fees-table-body');
                const rows = Array.from(table.querySelectorAll('tr'));
                
                // Toggle sort direction if clicking the same column
                if (currentSortColumn === column) {
                    sortDirection *= -1;
                } else {
                    currentSortColumn = column;
                    sortDirection = 1;
                }
                
                // Remove previous sort indicators
                document.querySelectorAll('th[data-sort]').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });
                
                // Add sort indicator to current column
                const header = document.querySelector(`th[data-sort="${column}"]`);
                header.classList.add(sortDirection === 1 ? 'sort-asc' : 'sort-desc');
                
                rows.sort((a, b) => {
                    let aValue, bValue;
                    
                    if (column === 'balance') {
                        aValue = parseFloat(a.querySelector('td:nth-child(6)').textContent);
                        bValue = parseFloat(b.querySelector('td:nth-child(6)').textContent);
                    } else if (column === 'status') {
                        aValue = a.querySelector('select').value;
                        bValue = b.querySelector('select').value;
                    } else if (column === 'amount') {
                        aValue = parseFloat(a.querySelector('.fee-total-due').value);
                        bValue = parseFloat(b.querySelector('.fee-total-due').value);
                    } else if (column === 'paid') {
                        aValue = parseFloat(a.querySelector('.fee-amount-paid').value);
                        bValue = parseFloat(b.querySelector('.fee-amount-paid').value);
                    } else if (column === 'duedate') {
                        aValue = a.querySelector('.fee-due-date').value;
                        bValue = b.querySelector('.fee-due-date').value;
                    } else {
                        // For other columns, get the text content
                        const cellIndex = Array.from(header.parentNode.children).indexOf(header) + 1;
                        aValue = a.querySelector(`td:nth-child(${cellIndex})`).textContent;
                        bValue = b.querySelector(`td:nth-child(${cellIndex})`).textContent;
                    }
                    
                    // Compare values
                    if (aValue < bValue) return -1 * sortDirection;
                    if (aValue > bValue) return 1 * sortDirection;
                    return 0;
                });
                
                // Rebuild the table
                rows.forEach(row => table.appendChild(row));
            }
            
            // Apply filters to fees table
            function applyFeesFilters() {
                const classFilter = feesClassFilter.value.toLowerCase();
                const statusFilter = feesStatusFilter.value.toLowerCase();
                const searchTerm = feesSearch.value.toLowerCase();
                
                document.querySelectorAll('#fees-table-body tr').forEach(row => {
                    const className = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const status = row.querySelector('select').value.toLowerCase();
                    const studentName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    
                    const classMatch = !classFilter || className.includes(classFilter);
                    const statusMatch = !statusFilter || status === statusFilter;
                    const searchMatch = !searchTerm || studentName.includes(searchTerm);
                    
                    row.style.display = classMatch && statusMatch && searchMatch ? '' : 'none';
                });
            }
            
            // Refresh fees data
            refreshFeesBtn.addEventListener('click', function() {
                loadFeesData();
                loadFeeTypes();
            });
            
            // Initialize date fields with today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('student-dob').max = today;
            document.getElementById('enrollment-date').value = today;
            
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loginPage.classList.add('hidden');
                    app.classList.remove('hidden');
                    loadData();
                }
            });
            
            // Tab functionality
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Load admissions data
            function loadAdmissionsData() {
                firebase.get(firebase.child(admissionsRef, '/')).then((snapshot) => {
                    const admissions = snapshot.val() || {};
                    const pendingTable = document.getElementById('pending-admissions');
                    const reviewTable = document.getElementById('review-admissions');
                    const processedTable = document.getElementById('processed-admissions');
                    
                    pendingTable.innerHTML = '';
                    reviewTable.innerHTML = '';
                    processedTable.innerHTML = '';
                    
                    for (const id in admissions) {
                        const admission = admissions[id];
                        const row = document.createElement('tr');
                        
                        const basicInfo = `
                            <td>${id.substring(0, 8)}</td>
                            <td>${admission.firstName} ${admission.lastName}</td>
                            <td>${admission.applyingGrade}</td>
                            <td>${admission.parentName}</td>
                            <td>${new Date(admission.applicationDate).toLocaleDateString()}</td>
                        `;
                        
                        if (admission.status === 'pending') {
                            row.innerHTML = basicInfo + `
                                <td>
                                    <button class="action-btn edit-btn view-admission" data-id="${id}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            `;
                            pendingTable.appendChild(row);
                        } else if (admission.status === 'under-review') {
                            row.innerHTML = basicInfo + `
                                <td>
                                    <button class="action-btn edit-btn view-admission" data-id="${id}">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            `;
                            reviewTable.appendChild(row);
                        } else {
                            row.innerHTML = `
                                <td>${id.substring(0, 8)}</td>
                                <td>${admission.firstName} ${admission.lastName}</td>
                                <td>${admission.applyingGrade}</td>
                                <td><span class="admission-status ${admission.status}">${admission.status}</span></td>
                                <td>${admission.feedback || 'N/A'}</td>
                                <td>${admission.updatedAt ? new Date(admission.updatedAt).toLocaleDateString() : 'N/A'}</td>
                            `;
                            processedTable.appendChild(row);
                        }
                    }
                    
                    // Add event listeners to view buttons
                    document.querySelectorAll('.view-admission').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const appId = this.getAttribute('data-id');
                            viewAdmissionDetails(appId);
                        });
                    });
                }).catch(error => {
                    console.error("Error loading admissions:", error);
                });
            }
            
            // View admission details
            function viewAdmissionDetails(appId) {
                firebase.get(firebase.ref(db, `admissions/${appId}`)).then((snapshot) => {
                    const admission = snapshot.val();
                    
                    let statusBadge = '';
                    switch (admission.status) {
                        case 'pending':
                            statusBadge = '<span class="admission-status pending">Pending</span>';
                            break;
                        case 'under-review':
                            statusBadge = '<span class="admission-status under-review">Under Review</span>';
                            break;
                        case 'accepted':
                            statusBadge = '<span class="admission-status accepted">Accepted</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span class="admission-status rejected">Rejected</span>';
                            break;
                    }
                    
                    document.getElementById('admission-details-content').innerHTML = `
                        <div class="admission-details">
                            <div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Application ID</div>
                                    <div class="admission-detail-value">${appId}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Student Name</div>
                                    <div class="admission-detail-value">${admission.firstName} ${admission.lastName}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Date of Birth</div>
                                    <div class="admission-detail-value">${admission.dob}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Gender</div>
                                    <div class="admission-detail-value">${admission.gender}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Applying for Grade</div>
                                    <div class="admission-detail-value">${admission.applyingGrade}</div>
                                </div>
                            </div>
                            <div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Parent/Guardian</div>
                                    <div class="admission-detail-value">${admission.parentName}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Parent Phone</div>
                                    <div class="admission-detail-value">${admission.parentPhone}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Parent Email</div>
                                    <div class="admission-detail-value">${admission.parentEmail}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Address</div>
                                    <div class="admission-detail-value">${admission.address}</div>
                                </div>
                                <div class="admission-detail-group">
                                    <div class="admission-detail-label">Previous School</div>
                                    <div class="admission-detail-value">${admission.previousSchool || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="admission-detail-group">
                            <div class="admission-detail-label">Additional Notes</div>
                            <div class="admission-detail-value">${admission.notes || 'N/A'}</div>
                        </div>
                        <div class="admission-detail-group">
                            <div class="admission-detail-label">Status</div>
                            <div class="admission-detail-value">${statusBadge}</div>
                        </div>
                        ${admission.feedback ? `
                        <div class="admission-detail-group">
                            <div class="admission-detail-label">Feedback</div>
                            <div class="admission-detail-value">${admission.feedback}</div>
                        </div>
                        ` : ''}
                    `;
                    
                    // Set up action buttons based on status
                    const actionButtons = document.getElementById('admission-action-buttons');
                    actionButtons.innerHTML = '';
                    
                    if (admission.status === 'pending' || admission.status === 'under-review') {
                        const updateBtn = document.createElement('button');
                        updateBtn.className = 'btn btn-primary';
                        updateBtn.innerHTML = '<i class="fas fa-edit"></i> Update Status';
                        updateBtn.addEventListener('click', () => {
                            document.getElementById('current-application-id').value = appId;
                            document.getElementById('admission-status').value = admission.status === 'pending' ? 'under-review' : admission.status;
                            document.getElementById('admission-feedback').value = admission.feedback || '';
                            closeAllModals();
                            openModal('admission-feedback-modal');
                        });
                        actionButtons.appendChild(updateBtn);
                    }
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'btn btn-secondary';
                    closeBtn.innerHTML = '<i class="fas fa-times"></i> Close';
                    closeBtn.addEventListener('click', closeAllModals);
                    actionButtons.appendChild(closeBtn);
                    
                    openModal('admission-details-modal');
                }).catch(error => {
                    console.error("Error loading admission details:", error);
                });
            }
            
            // Admission feedback form
            document.getElementById('admission-feedback-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const appId = document.getElementById('current-application-id').value;
                const status = document.getElementById('admission-status').value;
                const feedback = document.getElementById('admission-feedback').value;
                
                const updates = {
                    status: status,
                    feedback: feedback,
                    updatedAt: new Date().toISOString()
                };
                
                firebase.update(firebase.ref(db, `admissions/${appId}`), updates)
                    .then(() => {
                        alert('Admission status updated successfully!');
                        closeAllModals();
                        loadAdmissionsData();
                    })
                    .catch((error) => {
                        alert('Error updating admission: ' + error.message);
                    });
            });
            
            // View admissions stats
            document.getElementById('view-admissions-stats').addEventListener('click', function() {
                firebase.get(firebase.child(admissionsRef, '/')).then((snapshot) => {
                    const admissions = snapshot.val() || {};
                    let pending = 0, review = 0, accepted = 0, rejected = 0;
                    
                    for (const id in admissions) {
                        switch (admissions[id].status) {
                            case 'pending': pending++; break;
                            case 'under-review': review++; break;
                            case 'accepted': accepted++; break;
                            case 'rejected': rejected++; break;
                        }
                    }
                    
                    const total = pending + review + accepted + rejected;
                    
                    document.getElementById('report-modal-title').textContent = 'Admissions Statistics';
                    document.getElementById('report-content').innerHTML = `
                        <h3>Admissions Overview</h3>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-value">${total}</div>
                                <div class="stat-label">Total Applications</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${pending}</div>
                                <div class="stat-label">Pending</div>
                                <div>${Math.round((pending / total) * 100)}% of total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${review}</div>
                                <div class="stat-label">Under Review</div>
                                <div>${Math.round((review / total) * 100)}% of total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${accepted + rejected}</div>
                                <div class="stat-label">Processed</div>
                                <div>${Math.round(((accepted + rejected) / total) * 100)}% of total</div>
                            </div>
                        </div>
                        
                        <h4>Status Breakdown</h4>
                        <div style="background: #f5f6fa; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                                <div style="width: ${(pending / total) * 100}%; background: #fdcb6e;"></div>
                                <div style="width: ${(review / total) * 100}%; background: #6c5ce7;"></div>
                                <div style="width: ${(accepted / total) * 100}%; background: #00b894;"></div>
                                <div style="width: ${(rejected / total) * 100}%; background: #d63031;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <div><span style="color: #fdcb6e;">■</span> Pending (${pending})</div>
                                <div><span style="color: #6c5ce7;">■</span> Under Review (${review})</div>
                                <div><span style="color: #00b894;">■</span> Accepted (${accepted})</div>
                                <div><span style="color: #d63031;">■</span> Rejected (${rejected})</div>
                            </div>
                        </div>
                        
                        <h4>Recent Activity</h4>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Application ID</th>
                                    <th>Student</th>
                                    <th>Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(admissions).slice(-5).reverse().map(([id, admission]) => `
                                    <tr>
                                        <td>${new Date(admission.applicationDate).toLocaleDateString()}</td>
                                        <td>${id.substring(0, 8)}</td>
                                        <td>${admission.firstName} ${admission.lastName}</td>
                                        <td>${admission.applyingGrade}</td>
                                        <td><span class="admission-status ${admission.status}">${admission.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    openModal('report-modal');
                }).catch(error => {
                    console.error("Error loading admissions stats:", error);
                });
            });
            
            // Load logins data
            function loadLoginsData(searchTerm = '') {
                firebase.get(firebase.child(loginsRef, '/')).then((snapshot) => {
                    const logins = snapshot.val() || {};
                    const loginsContainer = document.getElementById('logins-container');
                    loginsContainer.innerHTML = '';
                    
                    // Convert to array and sort by timestamp (newest first)
                    const loginArray = Object.entries(logins)
                        .map(([id, login]) => ({ id, ...login }))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Filter if search term exists
                    const filteredLogins = searchTerm 
                        ? loginArray.filter(login => 
                            login.email.toLowerCase().includes(searchTerm.toLowerCase()) || 
                            login.role.toLowerCase().includes(searchTerm.toLowerCase()))
                        : loginArray;
                    
                    if (filteredLogins.length === 0) {
                        loginsContainer.innerHTML = '<p>No login records found</p>';
                        return;
                    }
                    
                    filteredLogins.forEach(login => {
                        const loginRecord = document.createElement('div');
                        loginRecord.className = 'login-record';
                        
                        loginRecord.innerHTML = `
                            <div class="login-header">
                                <div class="login-user">${login.email}</div>
                                <div class="login-time">${new Date(login.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="login-details">
                                <div class="login-detail">
                                    <span class="login-detail-label">Role:</span>
                                    <span>${login.role}</span>
                                </div>
                                <div class="login-detail">
                                    <span class="login-detail-label">Status:</span>
                                    <span class="login-status ${login.success ? 'success' : 'failed'}">
                                        ${login.success ? 'Success' : 'Failed'}
                                    </span>
                                </div>
                            </div>
                        `;
                        
                        loginsContainer.appendChild(loginRecord);
                    });
                }).catch(error => {
                    console.error("Error loading logins:", error);
                });
            }
            
            // Search logins
            searchLoginsBtn.addEventListener('click', function() {
                loadLoginsData(loginsSearch.value);
            });
            
            // Refresh logins
            refreshLoginsBtn.addEventListener('click', function() {
                loadLoginsData();
                loginsSearch.value = '';
            });
            
            // Generate reports
            function generateReport(type) {
                const reportTitle = document.getElementById('report-modal-title');
                const reportContent = document.getElementById('report-content');
                
                let title = '';
                let content = '';
                
                switch (type) {
                    case 'students':
                        title = 'Student Report';
                        firebase.get(firebase.child(studentsRef, '/')).then((snapshot) => {
                            const students = snapshot.val() || {};
                            content = `
                                <h3>Student Report</h3>
                                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                                <p>Total Students: ${Object.keys(students).length}</p>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Class</th>
                                            <th>Gender</th>
                                            <th>Parent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(students).map(([id, student]) => `
                                            <tr>
                                                <td>${id.substring(0, 8)}</td>
                                                <td>${student.firstName} ${student.lastName}</td>
                                                <td>${student.class || 'N/A'}</td>
                                                <td>${student.gender}</td>
                                                <td>${student.parentName}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            reportContent.innerHTML = content;
                            openModal('report-modal');
                        });
                        break;
                        
                    case 'teachers':
                        title = 'Teacher Report';
                        firebase.get(firebase.child(teachersRef, '/')).then((snapshot) => {
                            const teachers = snapshot.val() || {};
                            content = `
                                <h3>Teacher Report</h3>
                                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                                <p>Total Teachers: ${Object.keys(teachers).length}</p>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Subjects</th>
                                            <th>Class</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.entries(teachers).map(([id, teacher]) => `
                                            <tr>
                                                <td>${id.substring(0, 8)}</td>
                                                <td>${teacher.firstName} ${teacher.lastName}</td>
                                                <td>${teacher.email}</td>
                                                <td>${teacher.subjects}</td>
                                                <td>${teacher.assignedClass || 'N/A'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                            reportContent.innerHTML = content;
                            openModal('report-modal');
                        });
                        break;
                        
                    case 'finance':
                        title = 'Finance Report';
                        Promise.all([
                            firebase.get(firebase.child(feeTypesRef, '/')),
                            firebase.get(firebase.child(feesRef, '/'))
                        ]).then(([feeTypesSnapshot, feesSnapshot]) => {
                            const feeTypes = feeTypesSnapshot.val() || {};
                            const fees = feesSnapshot.val() || {};
                            
                            let totalIncome = 0;
                            let totalUnpaid = 0;
                            
                            // Calculate total income from fee types
                            for (const id in feeTypes) {
                                totalIncome += feeTypes[id].amount;
                            }
                            
                            // Calculate total unpaid fees
                            for (const studentId in fees) {
                                const studentFees = fees[studentId];
                                if (studentFees.feeItems) {
                                    for (const feeId in studentFees.feeItems) {
                                        const fee = studentFees.feeItems[feeId];
                                        if (fee.status !== 'paid') {
                                            totalUnpaid += (fee.amountDue - fee.amountPaid);
                                        }
                                    }
                                } else if (studentFees.amountDue !== undefined) {
                                    if (studentFees.status !== 'paid') {
                                        totalUnpaid += (studentFees.amountDue - studentFees.amountPaid);
                                    }
                                }
                            }
                            
                            content = `
                                <h3>Finance Report</h3>
                                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                                <div class="finance-summary">
                                    <p>Total Potential Income: $${totalIncome.toLocaleString()}</p>
                                    <p>Total Unpaid Fees: $${totalUnpaid.toLocaleString()}</p>
                                    <p>Projected Monthly Income: $15,000</p>
                                    <p>Projected Monthly Expenses: $10,000</p>
                                    <p>Net Monthly Profit: $5,000</p>
                                </div>
                                <div class="finance-breakdown">
                                    <h4>Income Breakdown</h4>
                                    <ul>
                                        <li>Tuition Fees: 60%</li>
                                        <li>Government Funding: 20%</li>
                                        <li>Donations: 15%</li>
                                        <li>Other: 5%</li>
                                    </ul>
                                    <h4>Expense Breakdown</h4>
                                    <ul>
                                        <li>Salaries: 50%</li>
                                        <li>Facilities: 20%</li>
                                        <li>Supplies: 15%</li>
                                        <li>Other: 15%</li>
                                    </ul>
                                </div>
                            `;
                            reportContent.innerHTML = content;
                            openModal('report-modal');
                        });
                        break;
                        
                    case 'fees':
                        title = 'Fees Report';
                        Promise.all([
                            firebase.get(firebase.child(studentsRef, '/')),
                            firebase.get(firebase.child(classesRef, '/')),
                            firebase.get(firebase.child(feesRef, '/')),
                            firebase.get(firebase.child(feeTypesRef, '/'))
                        ]).then(([studentsSnapshot, classesSnapshot, feesSnapshot, feeTypesSnapshot]) => {
                            const students = studentsSnapshot.val() || {};
                            const classes = classesSnapshot.val() || {};
                            const fees = feesSnapshot.val() || {};
                            const feeTypes = feeTypesSnapshot.val() || {};
                            
                            let totalDue = 0;
                            let totalPaid = 0;
                            let totalUnpaid = 0;
                            let feeStats = {};
                            
                            // Calculate totals and statistics
                            for (const studentId in fees) {
                                const studentFees = fees[studentId];
                                if (studentFees.feeItems) {
                                    for (const feeId in studentFees.feeItems) {
                                        const fee = studentFees.feeItems[feeId];
                                        totalDue += fee.amountDue;
                                        totalPaid += fee.amountPaid;
                                        
                                        if (fee.status !== 'paid') {
                                            totalUnpaid += (fee.amountDue - fee.amountPaid);
                                        }
                                        
                                        // Update fee type statistics
                                        if (!feeStats[feeId]) {
                                            feeStats[feeId] = {
                                                title: fee.title || 'Unnamed Fee',
                                                totalDue: 0,
                                                totalPaid: 0,
                                                students: 0
                                            };
                                        }
                                        feeStats[feeId].totalDue += fee.amountDue;
                                        feeStats[feeId].totalPaid += fee.amountPaid;
                                        feeStats[feeId].students++;
                                    }
                                } else if (studentFees.amountDue !== undefined) {
                                    totalDue += studentFees.amountDue;
                                    totalPaid += studentFees.amountPaid;
                                    
                                    if (studentFees.status !== 'paid') {
                                        totalUnpaid += (studentFees.amountDue - studentFees.amountPaid);
                                    }
                                }
                            }
                            
                            // Generate fee type statistics HTML
                            let feeTypeStatsHTML = '';
                            for (const feeId in feeStats) {
                                const feeStat = feeStats[feeId];
                                const paidPercentage = (feeStat.totalPaid / feeStat.totalDue * 100).toFixed(1);
                                
                                feeTypeStatsHTML += `
                                    <tr>
                                        <td>${feeStat.title}</td>
                                        <td>$${feeStat.totalDue.toFixed(2)}</td>
                                        <td>$${feeStat.totalPaid.toFixed(2)}</td>
                                        <td>$${(feeStat.totalDue - feeStat.totalPaid).toFixed(2)}</td>
                                        <td>${paidPercentage}%</td>
                                        <td>${feeStat.students}</td>
                                    </tr>
                                `;
                            }
                            
                            // Generate unpaid fees list
                            let unpaidFeesHTML = '';
                            for (const studentId in fees) {
                                const student = students[studentId] || {};
                                const studentFees = fees[studentId];
                                let studentUnpaid = 0;
                                
                                if (studentFees.feeItems) {
                                    for (const feeId in studentFees.feeItems) {
                                        const fee = studentFees.feeItems[feeId];
                                        if (fee.status !== 'paid') {
                                            studentUnpaid += (fee.amountDue - fee.amountPaid);
                                        }
                                    }
                                } else if (studentFees.amountDue !== undefined && studentFees.status !== 'paid') {
                                    studentUnpaid = studentFees.amountDue - studentFees.amountPaid;
                                }
                                
                                if (studentUnpaid > 0) {
                                    const classInfo = classes[student.class] || {};
                                    unpaidFeesHTML += `
                                        <tr>
                                            <td>${studentId.substring(0, 8)}</td>
                                            <td>${student.firstName} ${student.lastName}</td>
                                            <td>${classInfo.name || 'N/A'}</td>
                                            <td>$${studentUnpaid.toFixed(2)}</td>
                                        </tr>
                                    `;
                                }
                            }
                            
                            content = `
                                <h3>Fees Report</h3>
                                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                                
                                <div class="stats-container">
                                    <div class="stat-card">
                                        <div class="stat-value">$${totalDue.toFixed(2)}</div>
                                        <div class="stat-label">Total Due</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">$${totalPaid.toFixed(2)}</div>
                                        <div class="stat-label">Total Paid</div>
                                        <div>${(totalPaid / totalDue * 100).toFixed(1)}% collected</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value">$${totalUnpaid.toFixed(2)}</div>
                                        <div class="stat-label">Total Unpaid</div>
                                    </div>
                                </div>
                                
                                <h4>Fee Type Statistics</h4>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Fee Type</th>
                                            <th>Total Due</th>
                                            <th>Total Paid</th>
                                            <th>Balance</th>
                                            <th>% Paid</th>
                                            <th>Students</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${feeTypeStatsHTML}
                                    </tbody>
                                </table>
                                
                                <h4>Unpaid Fees (${totalUnpaid > 0 ? Object.keys(fees).length : 0} Students)</h4>
                                ${totalUnpaid > 0 ? `
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Student ID</th>
                                            <th>Name</th>
                                            <th>Class</th>
                                            <th>Amount Due</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${unpaidFeesHTML}
                                    </tbody>
                                </table>
                                ` : '<p>All fees have been paid.</p>'}
                            `;
                            
                            reportContent.innerHTML = content;
                            openModal('report-modal');
                        });
                        break;
                }
                
                reportTitle.textContent = title;
            }
            
            // Print report
            document.getElementById('print-report-btn').addEventListener('click', function() {
                window.print();
            });
            
            // Generate a random password
            function generatePassword() {
                const length = 10;
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
                let password = "";
                
                for (let i = 0; i < length; i++) {
                    const randomIndex = Math.floor(Math.random() * charset.length);
                    password += charset[randomIndex];
                }
                
                return password;
            }
            
            // Send login credentials via Formspree
            function sendLoginCredentials(email, password, name, role) {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('name', name);
                formData.append('role', role);
                formData.append('school', document.getElementById('school-name').value || 'EduManage Pro');
                
                // Replace with your Formspree form ID
                fetch('https://formspree.io/f/YOUR_FORMSPREE_ID', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to send email');
                    }
                    console.log('Login credentials sent successfully');
                })
                .catch(error => {
                    console.error('Error sending login credentials:', error);
                });
            }
            
            // Form submissions
            document.getElementById('add-student-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const firstName = document.getElementById('student-first-name').value;
                const lastName = document.getElementById('student-last-name').value;
                const parentEmail = document.getElementById('student-parent-email').value;
                
                // Generate a temporary password
                const tempPassword = generatePassword();
                
                const student = {
                    firstName: firstName,
                    lastName: lastName,
                    gender: document.getElementById('student-gender').value,
                    dob: document.getElementById('student-dob').value,
                    address: document.getElementById('student-address').value,
                    parentName: document.getElementById('student-parent-name').value,
                    parentPhone: document.getElementById('student-parent-phone').value,
                    parentEmail: parentEmail,
                    class: document.getElementById('student-class').value,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                const newStudentRef = firebase.push(studentsRef);
                firebase.set(newStudentRef, student)
                    .then(() => {
                        // Send login credentials to parent
                        sendLoginCredentials(
                            parentEmail,
                            tempPassword,
                            `${firstName} ${lastName}`,
                            'parent'
                        );
                        
                        alert('Student added successfully! Login credentials sent to parent email.');
                        closeAllModals();
                        this.reset();
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error adding student: ' + error.message);
                    });
            });
            
            document.getElementById('add-teacher-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const firstName = document.getElementById('teacher-first-name').value;
                const lastName = document.getElementById('teacher-last-name').value;
                const email = document.getElementById('teacher-email').value;
                const tempPassword = generatePassword();
                
                // First create auth user
                firebase.createUserWithEmailAndPassword(auth, email, tempPassword)
                    .then((userCredential) => {
                        const teacher = {
                            firstName: firstName,
                            lastName: lastName,
                            email: email,
                            gender: document.getElementById('teacher-gender').value,
                            phone: document.getElementById('teacher-phone').value,
                            subjects: document.getElementById('teacher-subjects').value,
                            assignedClass: document.getElementById('teacher-class').value || null,
                            status: 'active',
                            joinDate: new Date().toISOString().split('T')[0]
                        };
                        
                        // Then save teacher data
                        const newTeacherRef = firebase.push(teachersRef);
                        return firebase.set(newTeacherRef, teacher);
                    })
                    .then(() => {
                        // Send login credentials to teacher
                        sendLoginCredentials(
                            email,
                            tempPassword,
                            `${firstName} ${lastName}`,
                            'teacher'
                        );
                        
                        alert('Teacher added successfully! Login credentials sent to teacher email.');
                        closeAllModals();
                        this.reset();
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error adding teacher: ' + error.message);
                    });
            });
            
            document.getElementById('add-class-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const cls = {
                    name: document.getElementById('class-name').value,
                    teacherId: document.getElementById('class-teacher').value || null,
                    room: document.getElementById('class-room').value,
                    capacity: document.getElementById('class-capacity').value,
                    schedule: document.getElementById('class-schedule').value,
                    studentCount: 0
                };
                
                const newClassRef = firebase.push(classesRef);
                firebase.set(newClassRef, cls)
                    .then(() => {
                        alert('Class added successfully!');
                        closeAllModals();
                        this.reset();
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error adding class: ' + error.message);
                    });
            });
            
            document.getElementById('enrollment-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const enrollment = {
                    studentId: document.getElementById('enrollment-student').value,
                    classId: document.getElementById('enrollment-class').value,
                    date: document.getElementById('enrollment-date').value || new Date().toISOString().split('T')[0],
                    status: 'active'
                };
                
                const newEnrollmentRef = firebase.push(enrollmentsRef);
                firebase.set(newEnrollmentRef, enrollment)
                    .then(() => {
                        // Update student's class
                        const studentRef = firebase.ref(db, `students/${enrollment.studentId}`);
                        return firebase.update(studentRef, { class: enrollment.classId });
                    })
                    .then(() => {
                        // Update class student count
                        return firebase.get(firebase.ref(db, `classes/${enrollment.classId}/studentCount`));
                    })
                    .then((snapshot) => {
                        const currentCount = snapshot.val() || 0;
                        return firebase.update(firebase.ref(db, `classes/${enrollment.classId}`), { 
                            studentCount: currentCount + 1 
                        });
                    })
                    .then(() => {
                        alert('Enrollment completed successfully!');
                        closeAllModals();
                        this.reset();
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error completing enrollment: ' + error.message);
                    });
            });
            
            document.getElementById('school-settings-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const schoolInfo = {
                    name: document.getElementById('school-name').value,
                    address: document.getElementById('school-address').value,
                    phone: document.getElementById('school-phone').value,
                    email: document.getElementById('school-email').value,
                    updatedAt: new Date().toISOString()
                };
                
                firebase.set(schoolRef, schoolInfo)
                    .then(() => {
                        alert('School information updated successfully!');
                        loadData();
                    })
                    .catch((error) => {
                        alert('Error updating school information: ' + error.message);
                    });
            });
        });
    </script>
</body>
</html>
